<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>見積書作成ツール</title>
    <!-- Favicon -->
    <link rel="icon" href="https://placehold.co/32x32/ffffff/000000?text=積" type="image/png">
    <!-- Apple Touch Icon (iOSホーム画面用) -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/ffffff/000000?text=積">\
    <!-- Web App Manifest (Android PWA設定用) -->
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">\
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>\
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Yu Gothic', 'Meiryo', sans-serif; /* 日本語フォントを優先 */
            background-color: #f3f4f6; /* Light gray background */
            color: #333;
        }
        /* Custom scrollbar for table container */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #e2e8f0; /* bg-gray-200 */
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #94a3b8; /* bg-slate-400 */
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* bg-slate-600 */
        }
        /* Style for the element to be captured as PDF (hidden from view) */
        /* PDFのA4サイズに近づけるための基準設定 (約 794px x 1123px @96DPI) */
        /* padding は html2canvas のレンダリングにも影響するため、内側のコンテンツで調整 */
        #pdf-export-content {
            position: absolute;
            left: -9999px; /* Off-screen */
            top: -9999px; /* Off-screen */
            width: 210mm; /* A4 width */
            height: 297mm; /* A4 height */
            box-sizing: border-box; /* paddingを含めたサイズ */
            background-color: #ffffff; /* Ensure white background for PDF */
            font-family: 'Yu Gothic', 'Meiryo', 'Inter', sans-serif; /* PDF出力時の日本語フォント優先 */
            color: #333;
            /* overflow: hidden; /* コンテンツがはみ出さないように */
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <!-- PDF出力用にレンダリングする非表示の要素 -->
    <div id="pdf-export-content"></div>

    <!-- React and Babel for JSX transpilation -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- React Code - Transpiled from JSX manually -->
    <script>
        const { useState, useEffect, useCallback, useRef } = React;
        const { jsPDF } = window.jspdf;

        // localStorageのキー
        const LOCAL_STORAGE_KEY = 'quotation_tool_products';

        // グローバルなメッセージモーダルコンポーネント
        const GlobalMessageModal = ({ show, content, onClose, onConfirm, showConfirmButton }) => {
            if (!show) return null;
            return React.createElement(
                "div",
                { className: "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4" },
                React.createElement(
                    "div",
                    { className: "bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center" },
                    React.createElement(
                        "p",
                        { className: "text-lg font-semibold text-gray-800 mb-4" },
                        content
                    ),
                    React.createElement(
                        "div",
                        { className: "flex justify-center space-x-4" },
                        React.createElement(
                            "button",
                            {
                                onClick: onClose,
                                className: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105"
                            },
                            "閉じる"
                        ),
                        showConfirmButton && React.createElement(
                            "button",
                            {
                                onClick: onConfirm,
                                className: "bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105"
                            },
                            "削除"
                        )
                    )
                )
            );
        };

        // 見積書作成ページコンポーネント
        const QuotationPage = ({ productData, showMessageModal }) => {
            // State for invoice details
            const [recipientCompanyName, setRecipientCompanyName] = useState(''); // 初期値なし
            const [issueDate, setIssueDate] = useState(''); // 初期値なし
            const [subject, setSubject] = useState(''); // 初期値なし
            const [deliveryDate, setDeliveryDate] = useState(''); // 初期値なし
            const [paymentTerms, setPaymentTerms] = useState(''); // 初期値なし
            // 有効期限を「〇週間後」で管理するための新しいstate
            const [weeksValidity, setWeeksValidity] = useState(2); 

            // State for sender details (from PDF)
            // const [senderCompanyName, setSenderCompanyName] = useState(''); // 削除
            // 郵便番号を2つの部分に分割して管理
            const [senderPostalCodePart1, setSenderPostalCodePart1] = useState(''); // 初期値なし
            const [senderPostalCodePart2, setSenderPostalCodePart2] = useState(''); // 初期値なし
            const [senderAddress, setSenderAddress] = useState(''); // 初期値なし
            const [senderTel, setSenderTel] = useState(''); // 初期値なし
            const [senderRepresentative, setSenderRepresentative] = useState(''); // 初期値なし

            // State for invoice items
            // Initializing with one default item as requested
            const [items, setItems] = useState([
                { id: 1, description: '', quantity: 1, unit: '', unitPrice: 0, amount: 0 }
            ]);

            // State for totals
            const [subtotal, setSubtotal] = useState(0);
            const [tax, setTax] = useState(0);
            const [total, setTotal] = useState(0);
            const [remarks, setRemarks] = useState('');

            // Tax rate (10% from PDF example)
            const TAX_RATE = 0.10;

            // Function to calculate amounts and totals
            const calculateTotals = useCallback(() => {
                let currentSubtotal = 0;
                const updatedItems = items.map(item => {
                    const qty = parseFloat(item.quantity) || 0;
                    const price = parseFloat(item.unitPrice) || 0;
                    const itemAmount = qty * price;
                    currentSubtotal += itemAmount;
                    return { ...item, amount: itemAmount };
                });

                // IMPORTANT FIX: Update the items state with the calculated amounts
                setItems(updatedItems); // これが抜けていました

                setSubtotal(currentSubtotal);
                setTax(Math.floor(currentSubtotal * TAX_RATE)); // Round tax down to integer
                setTotal(currentSubtotal + Math.floor(currentSubtotal * TAX_RATE));
            }, [items]);

            // Recalculate totals whenever items change
            useEffect(() => {
                calculateTotals();
            }, [items, calculateTotals]);

            // Handle item input changes
            const handleItemChange = (id, field, value) => {
                setItems(prevItems =>
                    prevItems.map(item => {
                        if (item.id === id) {
                            const updatedItem = { ...item, [field]: value };
                            
                            // If description changes, try to autofill unit and unitPrice from productData
                            if (field === 'description') {
                                const selectedProduct = productData.find(p => p.name === value);
                                if (selectedProduct) {
                                    // Autofill only if values are not already manually set
                                    if (item.unit === '' || item.unit === selectedProduct.unit) { // Only change if empty or matches old autofill
                                        updatedItem.unit = selectedProduct.unit;
                                    }
                                    if (item.unitPrice === 0 || item.unitPrice === selectedProduct.price) { // Only change if 0 or matches old autofill
                                        updatedItem.unitPrice = selectedProduct.price;
                                    }
                                }
                                // If no match, or if user types a non-matching name, don't clear existing unit/unitPrice.
                                // User can manually enter them.
                            }
                            return updatedItem;
                        }
                        return item;
                    })
                );
            };

            // Add a new item row
            const addItem = () => {
                const newId = items.length > 0 ? Math.max(...items.map(item => item.id)) + 1 : 1;
                setItems(prevItems => [
                    ...prevItems,
                    { id: newId, description: '', quantity: 1, unit: '', unitPrice: 0, amount: 0 }
                ]);
            };

            // Delete an item row
            const deleteItem = (id) => {
                setItems(prevItems => prevItems.filter(item => item.id !== id));
            };

            // Helper for formatting numbers with commas
            const formatNumber = (num) => num.toLocaleString('ja-JP');

            // 郵便番号から住所を自動取得する関数
            const fetchAddressByPostalCode = async () => {
                const zipcode = `${senderPostalCodePart1}${senderPostalCodePart2}`; // 2つのパートを結合
                if (zipcode.length !== 7) {
                    return; // 7桁でなければ何もしない
                }

                try {
                    const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${zipcode}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        const result = data.results[0];
                        const newAddress = `${result.address1}${result.address2}${result.address3}`;
                        setSenderAddress(newAddress);
                        // showMessageModal('住所を自動入力しました。'); // このメッセージは非表示
                    } else {
                        // showMessageModal('該当する住所が見つかりませんでした。'); // このメッセージも非表示
                    }
                } catch (error) {
                    console.error("住所取得エラー:", error);
                    // showMessageModal(`住所の取得中にエラーが発生しました: ${error.message}`); // このメッセージも非表示
                }
            };

            // PDF出力処理
            const handleGeneratePdf = async () => {
                // 有効期限の表示文字列を生成
                const displayValidityPeriod = `御見積後${weeksValidity}週間`;
                // 郵便番号を結合
                const fullSenderPostalCode = `${senderPostalCodePart1}-${senderPostalCodePart2}`;
                const fullSenderAddress = `〒${fullSenderPostalCode}\n${senderAddress}`.replace(/\n/g, '<br/>');

                // PDF出力用にレンダリングするコンテンツを生成
                const quotationHtml = `
                    <div style="width: 200mm; /* A4 width - 左右余白 (210mm - 10mm) */
                                margin: 0 auto; /* 中央揃え */
                                padding: 5mm; /* 上下左右の余白 */
                                box-sizing: border-box;
                                font-family: 'Yu Gothic', 'Meiryo', 'Inter', sans-serif;
                                color: #333;
                                line-height: 1.4;">

                        <!-- 見積書タイトルをページ最上部中央に配置 -->
                        <div style="font-size: 36px; font-weight: bold; text-align: center; margin-bottom: 20px; margin-top: 5mm;">見積書</div>

                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px;">
                            <div style="font-size: 20px; font-weight: bold; line-height: 1.3; border-bottom: 2px solid #000; display: inline-block; padding-bottom: 6px;">
                                ${recipientCompanyName} 御中
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; margin-top: 0;">${issueDate || 'YYYY年MM月DD日'}</div>
                                <div style="font-size: 12px; margin-top: 20px; line-height: 1.3;">
                                    <div style="font-weight: bold; margin-bottom: 3px;">${senderRepresentative}</div>
                                    <div style="margin-bottom: 3px;">${fullSenderAddress}</div>
                                    ${senderTel ? `<div style="margin-bottom: 3px;">${senderTel}</div>` : ''}
                                    ${senderRepresentative ? `<div style="font-weight: bold; margin-bottom: 10px;">${senderRepresentative}　<span style="border: 1px solid #000; width: 30px; height: 30px; margin-left: 5px; font-size: 16px; display: inline-flex; justify-content: center; align-items: center; box-sizing: border-box;">印</span></div>` : '<div style="font-weight: bold; margin-bottom: 10px;">　<span style="border: 1px solid #000; width: 30px; height: 30px; margin-left: 5px; font-size: 16px; display: inline-flex; justify-content: center; align-items: center; box-sizing: border-box;">印</span></div>'}
                                </div>
                            </div>
                        </div>

                        <div style="width: 90%; margin: 0 auto 30px auto; border: 1px solid #000; padding: 12px; box-sizing: border-box; background-color: #f9f9f9;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="width: 20%; padding: 8px; font-weight: bold; font-size: 13px; vertical-align: top; border-bottom: 1px solid #ccc;">件名</td>
                                    <td style="width: 80%; padding: 8px; border-bottom: 1px solid #ccc; font-size: 13px;">${subject}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; font-weight: bold; font-size: 13px; vertical-align: top; border-bottom: 1px solid #ccc;">納期</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ccc; font-size: 13px;">${deliveryDate}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; font-weight: bold; font-size: 13px; vertical-align: top; border-bottom: 1px solid #ccc;">支払条件</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #ccc; font-size: 13px;">${paymentTerms}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; font-weight: bold; font-size: 13px; vertical-align: top;">有効期限</td>
                                    <td style="padding: 8px; font-size: 13px;">${displayValidityPeriod}</td>
                                </tr>
                            </table>
                        </div>

                        <!-- 「下記の通り、御見積もり申し上げます。」を合計金額の直前に移動 -->
                        <div style="font-size: 14px; margin-bottom: 20px; text-align: right;">
                            下記の通り、御見積もり申し上げます。
                        </div>
                        <div style="text-align: right; margin-bottom: 25px; padding-right: 5mm;">
                            <span style="font-size: 20px; font-weight: bold; margin-right: 15px;">合計</span>
                            <span style="font-size: 36px; font-weight: bold; color: #000; padding-bottom: 5px; border-bottom: 2px solid #000; display: inline-block;">${formatNumber(total)} 円<span style="font-size: 16px; font-weight: normal; margin-left: 8px;">(税込)</span></span>
                        </div>

                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; border: 1px solid #000;">
                            <thead>
                                <tr style="background-color: #e0e0e0;">
                                    <th style="border: 1px solid #000; padding: 8px; text-align: left; font-size: 12px; width: 40%;">摘要</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: right; font-size: 12px; width: 10%;">数量</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: center; font-size: 12px; width: 10%;">単位</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: right; font-size: 12px; width: 20%;">単価</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: right; font-size: 12px; width: 20%;">金額</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: left; font-size: 12px;">${item.description}</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right; font-size: 12px;">${item.quantity}</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: center; font-size: 12px;">${item.unit}</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right; font-size: 12px;">${formatNumber(item.unitPrice)}</td>
                                        <td style="border: 1px solid #000; padding: 8px; text-align: right; font-size: 12px;">${formatNumber(item.amount)}</td>
                                    </tr>
                                `).join('')}
                                <!-- 小計・消費税・合計 -->
                                <tr style="background-color: #f9f9f9;">
                                    <td colSpan="3" style="border: 1px solid #000; padding: 8px; text-align: left;"></td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold; font-size: 12px;">小計</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold; font-size: 12px;">${formatNumber(subtotal)}</td>
                                </tr>
                                <tr style="background-color: #f9f9f9;">
                                    <td colSpan="3" style="border: 1px solid #000; padding: 8px; text-align: left;"></td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold; font-size: 12px;">消費税 (${TAX_RATE * 100}%)</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold; font-size: 12px;">${formatNumber(tax)}</td>
                                </tr>
                                <tr style="background-color: #f9f9f9;">
                                    <td colSpan="3" style="border: 1px solid #000; padding: 8px; text-align: left;"></td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold; font-size: 12px;">合計</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: right; font-weight: bold; font-size: 12px;">${formatNumber(total)}</td>
                                </tr>
                            </tbody>
                        </table>

                        <div style="margin-bottom: 20px;">
                            <p style="font-size: 13px; font-weight: bold; margin-bottom: 5px;">備考</p>
                            <div style="border: 1px solid #000; padding: 10px; min-height: 60px; font-size: 12px; white-space: pre-wrap;">
                                ${remarks || ''}
                            </div>
                        </div>

                        <p style="text-align: right; font-size: 11px; margin-top: 30px;">
                            本見積書の有効期限は、${displayValidityPeriod}です。
                        </p>
                    </div>
                `;

                // 一時divにHTMLコンテンツをセット
                const tempDiv = document.getElementById('pdf-export-content');
                if (!tempDiv) {
                    showMessageModal('PDF出力用の領域が見つかりません。');
                    return;
                }
                tempDiv.innerHTML = quotationHtml; // レンダリング用のHTMLをセット

                // html2canvasでHTML要素を画像としてキャプチャ
                try {
                    showMessageModal('PDFを生成中です...'); // 処理開始メッセージ
                    const canvas = await html2canvas(tempDiv, {
                        scale: 2, // 解像度を上げる
                        useCORS: true,
                        logging: true,
                        scrollX: 0,
                        scrollY: -window.scrollY // スクロール位置を考慮
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' for A4 size
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    
                    // imgHeightを計算し、1ページに収まるように調整
                    // 必要であればimgWidthを基準に高さを調整
                    const imgHeight = canvas.height * imgWidth / canvas.width;

                    // 1ページのみを追加
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                    // ファイル名を「件名_宛名.pdf」に変更
                    const fileName = `${subject || '見積書'}_${recipientCompanyName || '宛名なし'}.pdf`; // ファイル名を空にしない
                    pdf.save(fileName);
                    showMessageModal('PDFが生成されました！');
                } catch (error) {
                    console.error('PDF生成エラー:', error);
                    showMessageModal(`PDF生成中にエラーが発生しました: ${error.message}`);
                } finally {
                    tempDiv.innerHTML = ''; // 一時divの内容をクリア
                }
            };


            return React.createElement(
                "div",
                { className: "bg-white p-6 sm:p-10 rounded-xl shadow-2xl w-full border border-gray-200" },
                React.createElement(
                    "h1",
                    { className: "text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-8 pb-4 border-b-2 border-blue-200" },
                    "見積書作成ツール" // タイトル変更
                ),

                /* Header Section */
                React.createElement(
                    "div",
                    { className: "grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" },
                    React.createElement(
                        "div",
                        { className: "flex items-center space-x-2 w-full md:w-auto md:self-start" }, // flex-row, items-centerで横並びに
                        React.createElement(
                            "label",
                            { className: "text-sm font-semibold text-gray-600 w-auto" }, // ラベル幅を自動調整
                            "見積書の宛名:"
                        ),
                        React.createElement("input", {
                            type: "text",
                            className: "p-2 border border-gray-300 rounded-md text-base focus:ring-blue-500 focus:border-blue-500 flex-grow max-w-xs", // flex-growで伸びるように、max-w-xsで幅を小さく
                            value: recipientCompanyName,
                            onChange: (e) => setRecipientCompanyName(e.target.value),
                            placeholder: "例: 株式会社〇〇" 
                        })
                    ),

                    React.createElement(
                        "div",
                        { className: "flex flex-col items-start md:items-end space-y-4 w-full" }, // 日付と送付元情報のコンテナ
                        React.createElement(
                            "div",
                            { className: "flex items-center space-x-2 w-full md:w-auto md:self-end" }, // 日付入力欄を左寄せ
                            React.createElement(
                                "label",
                                { className: "text-sm font-semibold text-gray-600 w-auto" }, // ラベル幅を自動調整
                                "日付:"
                            ),
                            React.createElement("input", {
                                type: "date",
                                className: "p-2 border border-gray-300 rounded-md text-base focus:ring-blue-500 focus:border-blue-500 flex-grow", // 入力欄をフレックスで伸ばす
                                value: issueDate,
                                onChange: (e) => setIssueDate(e.target.value)
                            })
                        ),
                        /* Sender Information */
                        React.createElement(
                            "div",
                            { className: "text-right text-sm w-full md:w-auto md:ml-auto flex flex-col items-end space-y-2" }, // 送付元情報は右寄せ
                            // 会社名 + 郵便番号 の行 (会社名入力欄を削除)
                            React.createElement(
                                "div",
                                { className: "flex flex-wrap justify-end items-center gap-x-4 w-full" }, // Use gap-x-4 for horizontal spacing
                                // 会社名入力欄は削除
                                // 郵便番号入力フィールド
                                React.createElement(
                                    "div",
                                    { className: "flex items-center" },
                                    React.createElement(
                                        "label",
                                        { className: "text-sm font-semibold text-gray-600 mr-2" },
                                        "郵便番号:"
                                    ),
                                    React.createElement(
                                        "span",
                                        { className: "mr-1" },
                                        "〒"
                                    ),
                                    React.createElement("input", {
                                        type: "text",
                                        className: "w-16 p-1 border border-gray-300 rounded-md text-sm text-right focus:ring-blue-500 focus:border-blue-500",
                                        value: senderPostalCodePart1,
                                        onChange: (e) => setSenderPostalCodePart1(e.target.value),
                                        onBlur: fetchAddressByPostalCode, // フォーカスが外れたら住所を取得
                                        maxLength: "3",
                                        placeholder: "000"
                                    }),
                                    React.createElement(
                                        "span",
                                        { className: "mx-1" }, // ハイフンの代わりにスペース
                                        "-"
                                    ),
                                    React.createElement("input", {
                                        type: "text",
                                        className: "w-20 p-1 border border-gray-300 rounded-md text-sm text-right focus:ring-blue-500 focus:border-blue-500",
                                        value: senderPostalCodePart2,
                                        onChange: (e) => setSenderPostalCodePart2(e.target.value),
                                        onBlur: fetchAddressByPostalCode, // フォーカスが外れたら住所を取得
                                        maxLength: "4",
                                        placeholder: "0000"
                                    })
                                )
                            ),
                            // 住所入力欄 (単独行)
                            React.createElement(
                                "div",
                                { className: "flex items-start justify-end gap-x-2 w-full" }, // Consistent gap-x for alignment
                                React.createElement(
                                    "label",
                                    { className: "text-sm font-semibold text-gray-600 mt-1" }, // textareaと高さを合わせるためmt-1
                                    "住所:"
                                ),
                                React.createElement("textarea", {
                                    className: "w-full p-1 border border-gray-300 rounded-md text-sm resize-y max-w-[280px]", /* Adjusted max-w for textarea */
                                    rows: "3",
                                    value: senderAddress,
                                    onChange: (e) => setSenderAddress(e.target.value),
                                    placeholder: "例: 東京都千代田区1-2-3" 
                                })
                            ),
                            // 電話番号と代表者名入力欄
                            React.createElement(
                                "div",
                                { className: "flex flex-wrap justify-end items-center gap-x-4 w-full" },
                                // 電話番号入力欄
                                React.createElement(
                                    "div",
                                    { className: "flex items-center space-x-2" },
                                    React.createElement(
                                        "label",
                                        { className: "text-sm font-semibold text-gray-600" },
                                        "電話番号:"
                                    ),
                                    React.createElement("input", {
                                        type: "text",
                                        className: "p-1 border border-gray-300 rounded-md text-sm max-w-[160px] text-right",
                                        value: senderTel,
                                        onChange: (e) => setSenderTel(e.target.value),
                                        placeholder: "例: 090-1234-5678" 
                                    })
                                ),
                                // 代表者名入力欄
                                React.createElement(
                                    "div",
                                    { className: "flex items-center space-x-2" },
                                    React.createElement(
                                        "label",
                                        { className: "text-sm font-semibold text-gray-600" },
                                        "代表者名:"
                                    ),
                                    React.createElement("input", {
                                        type: "text",
                                        className: "p-1 border border-gray-300 rounded-md text-sm max-w-[160px] text-right",
                                        value: senderRepresentative,
                                        onChange: (e) => setSenderRepresentative(e.target.value),
                                        placeholder: "例: 山田太郎" 
                                    })
                                )
                            )
                        )
                    )
                ),

                /* Key Details Section */
                React.createElement(
                    "div",
                    { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8 p-4 bg-blue-50 rounded-lg border border-blue-200" },
                    React.createElement(
                        "div",
                        { className: "flex flex-col" },
                        React.createElement(
                            "label",
                            { className: "text-sm font-semibold text-blue-700 mb-1" },
                            "件名:"
                        ),
                        React.createElement("input", {
                            type: "text",
                            className: "p-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500",
                            value: subject,
                            onChange: (e) => setSubject(e.target.value),
                            placeholder: "例: Webサイト制作費用" 
                        })
                    ),
                    React.createElement(
                        "div",
                        { className: "flex flex-col" },
                        React.createElement(
                            "label",
                            { className: "text-sm font-semibold text-blue-700 mb-1" },
                            "納期:"
                        ),
                        React.createElement("input", {
                            type: "date",
                            className: "p-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500",
                            value: deliveryDate,
                            onChange: (e) => setDeliveryDate(e.target.value)
                        })
                    ),
                    React.createElement(
                        "div",
                        { className: "flex flex-col" },
                        React.createElement(
                            "label",
                            { className: "text-sm font-semibold text-blue-700 mb-1" },
                            "支払条件:"
                        ),
                        React.createElement("input", {
                            type: "text",
                            className: "p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",
                            value: paymentTerms,
                            onChange: (e) => setPaymentTerms(e.target.value),
                            placeholder: "例: 翌月末払い" 
                        })
                    ),
                    React.createElement(
                        "div",
                        { className: "flex flex-col lg:col-span-1" },
                        React.createElement(
                            "label",
                            { className: "text-sm font-semibold text-blue-700 mb-1" },
                            "有効期限:"
                        ),
                        // 有効期限の入力フィールドを数値入力に変更
                        React.createElement(
                            "div",
                            { className: "flex items-center" },
                            React.createElement(
                                "span",
                                { className: "text-gray-700 mr-2" },
                                "御見積後"
                            ),
                            React.createElement("input", {
                                type: "number",
                                className: "p-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-20 text-center", // 幅を調整
                                value: weeksValidity,
                                onChange: (e) => setWeeksValidity(parseInt(e.target.value) || 0),
                                min: "0"
                            }),
                            React.createElement(
                                "span",
                                { className: "text-gray-700 ml-2" },
                                "週間"
                            )
                        )
                    )
                ),

                React.createElement(
                    "div",
                    { className: "flex justify-end items-baseline mb-8" },
                    React.createElement(
                        "span",
                        { className: "text-xl sm:text-2xl font-bold mr-4 text-gray-700" },
                        "合計"
                    ),
                    React.createElement(
                        "span",
                        { className: "text-3xl sm:text-4xl font-extrabold text-blue-600" },
                        formatNumber(total),
                        " 円 (税込)"
                    )
                ),

                /* Items Table */
                React.createElement(
                    "div",
                    { className: "overflow-x-auto mb-8 shadow-md rounded-lg border border-gray-200" },
                    React.createElement(
                        "table",
                        { className: "min-w-full divide-y divide-gray-200" },
                        React.createElement(
                            "thead",
                            { className: "bg-blue-50" },
                            React.createElement(
                                "tr",
                                null,
                                React.createElement("th", { className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12" }),
                                React.createElement(
                                    "th",
                                    { className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-4/12" },
                                    "摘要"
                                ),
                                React.createElement(
                                    "th",
                                    { className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12" },
                                    "数量"
                                ),
                                React.createElement(
                                    "th",
                                    { className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12" },
                                    "単位"
                                ),
                                React.createElement(
                                    "th",
                                    { className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12" },
                                    "単価"
                                ),
                                React.createElement(
                                    "th",
                                    { className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12" },
                                    "金額"
                                )
                            )
                        ),
                        React.createElement(
                            "tbody",
                            { className: "bg-white divide-y divide-gray-200" },
                            items.map(item => React.createElement(
                                "tr",
                                { key: item.id },
                                React.createElement(
                                    "td",
                                    { className: "px-3 py-3 whitespace-nowrap" },
                                    React.createElement(
                                        "button",
                                        {
                                            onClick: () => deleteItem(item.id),
                                            className: "p-1 rounded-full bg-red-500 text-white hover:bg-red-600 transition duration-200",
                                            title: "項目を削除"
                                        },
                                        React.createElement(
                                            "svg",
                                            { xmlns: "http://www.w3.org/2000/svg", className: "h-4 w-4", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                                            React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: "2", d: "M6 18L18 6M6 6l12 12" })
                                        )
                                    )
                                ),
                                React.createElement(
                                    "td",
                                    { className: "px-3 py-3 whitespace-nowrap text-sm text-gray-900" },
                                    /* 商品名入力（datalistでサジェスト） */
                                    React.createElement("input", {
                                        type: "text",
                                        list: "product-names-datalist", // datalistと連携
                                        className: "w-full p-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",
                                        value: item.description,
                                        onChange: (e) => handleItemChange(item.id, 'description', e.target.value),
                                        placeholder: "商品名またはサービス名" 
                                    }),
                                    React.createElement(
                                        "datalist",
                                        { id: "product-names-datalist" },
                                        productData.map(product => React.createElement(
                                            "option",
                                            { key: product.id, value: product.name }
                                        ))
                                    )
                                ),
                                React.createElement("td", { className: "px-3 py-3 whitespace-nowrap text-sm text-gray-900" }, React.createElement("input", {
                                    type: "number",
                                    className: "w-full p-1 border border-gray-300 rounded-md text-right focus:ring-blue-500 focus:border-blue-500",
                                    value: item.quantity,
                                    onChange: (e) => handleItemChange(item.id, 'quantity', e.target.value),
                                    min: "0"
                                })),
                                React.createElement("td", { className: "px-3 py-3 whitespace-nowrap text-sm text-gray-900" }, React.createElement("input", {
                                    type: "text", // 読み取り専用を解除
                                    className: "w-full p-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",
                                    value: item.unit,
                                    onChange: (e) => handleItemChange(item.id, 'unit', e.target.value), // 直接setItemUnitを呼び出す
                                    placeholder: "個,式,枚など" 
                                })),
                                React.createElement("td", { className: "px-3 py-3 whitespace-nowrap text-sm text-gray-900" }, React.createElement("input", {
                                    type: "number", // 読み取り専用を解除
                                    className: "w-full p-1 border border-gray-300 rounded-md text-right focus:ring-blue-500 focus:border-blue-500",
                                    value: item.unitPrice,
                                    onChange: (e) => handleItemChange(item.id, 'unitPrice', e.target.value),
                                    min: "0"
                                })),
                                React.createElement(
                                    "td",
                                    { className: "px-3 py-3 whitespace-nowrap text-sm text-gray-900 text-right font-medium bg-gray-50" },
                                    formatNumber(item.amount)
                                )
                            ))
                        )
                    )
                ),

                React.createElement(
                    "div",
                    { className: "flex justify-between items-center mb-8" },
                    React.createElement(
                        "button",
                        {
                            onClick: addItem,
                            className: "px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105"
                        },
                        "項目を追加"
                    ),
                    React.createElement(
                        "div",
                        { className: "flex space-x-2" },
                        React.createElement(
                            "button",
                            {
                                onClick: handleGeneratePdf,
                                className: "px-6 py-2 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 transition duration-300 transform hover:scale-105"
                            },
                            "PDF出力"
                        )
                    )
                ),


                /* Totals Section */
                React.createElement(
                    "div",
                    { className: "flex justify-end mb-8" },
                    React.createElement(
                        "div",
                        { className: "w-full max-w-sm" },
                        React.createElement(
                            "div",
                            { className: "flex justify-between items-center py-2 border-b border-gray-200" },
                            React.createElement(
                                "span",
                                { className: "text-md sm:text-lg text-gray-700" },
                                "小計:"
                            ),
                            React.createElement(
                                "span",
                                { className: "text-md sm:text-lg font-semibold text-gray-800" },
                                formatNumber(subtotal),
                                " 円"
                            )
                        ),
                        React.createElement(
                            "div",
                            { className: "flex justify-between items-center py-2 border-b border-gray-200" },
                            React.createElement(
                                "span",
                                { className: "text-md sm:text-lg text-gray-700" },
                                `消費税 (${TAX_RATE * 100}%)`
                            ),
                            React.createElement(
                                "span",
                                { className: "text-md sm:text-lg font-semibold text-gray-800" },
                                formatNumber(tax),
                                " 円"
                            )
                        ),
                        React.createElement(
                            "div",
                            { className: "flex justify-between items-center py-3 font-bold text-lg sm:text-xl border-t-2 border-blue-300 mt-2" },
                            React.createElement(
                                "span",
                                null,
                                "合計:"
                            ),
                            React.createElement(
                                "span",
                                null,
                                formatNumber(total),
                                " 円"
                            )
                        )
                    )
                ),

                /* Remarks Section */
                React.createElement(
                    "div",
                    { className: "mb-8" },
                    React.createElement(
                        "label",
                        { htmlFor: "remarks", className: "block text-md font-semibold text-gray-700 mb-2" },
                        "備考:"
                    ),
                    React.createElement("textarea", {
                        id: "remarks",
                        className: "w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 resize-y",
                        rows: "4",
                        value: remarks,
                        onChange: (e) => setRemarks(e.target.value),
                        placeholder: "ご不明な点がございましたら、お気軽にお問い合わせください。"
                    })
                ),

                React.createElement(
                    "p",
                    { className: "text-center text-gray-500 text-sm mt-8" },
                    `本見積書の有効期限は、御見積後${weeksValidity}週間です。`
                )
            );
        };

        // 商品管理ページコンポーネント
        const ProductManagementPage = ({ productData, addProduct, updateProduct, deleteProduct, showMessageModal, showConfirmModal, importProductsFromCsv, exportProductsToCsv }) => {
            const [editingProduct, setEditingProduct] = useState(null); // 編集中商品のID
            const [newProductName, setNewProductName] = useState('');
            const [newProductUnit, setNewProductUnit] = useState('');
            const [newProductPrice, setNewProductPrice] = useState('');

            // 編集フォームをリセットする関数
            const resetForm = () => {
                setEditingProduct(null);
                setNewProductName('');
                setNewProductUnit('');
                setNewProductPrice('');
            };

            // 編集ボタンクリック時の処理
            const handleEditClick = (product) => {
                setEditingProduct(product.id);
                setNewProductName(product.name);
                setNewProductUnit(product.unit);
                setNewProductPrice(product.price);
            };

            // 商品追加・更新ボタンクリック時の処理
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!newProductName || !newProductUnit || newProductPrice === '') {
                    showMessageModal('商品名、単位、単価は必須です。'); // カスタムモーダルを使用
                    return;
                }
                const price = parseFloat(newProductPrice);
                if (isNaN(price) || price < 0) {
                    showMessageModal('単価は0以上の数値を入力してください。'); // カスタムモーダルを使用
                    return;
                }

                try {
                    if (editingProduct) {
                        // 更新処理
                        await updateProduct({ id: editingProduct, name: newProductName, unit: newProductUnit, price: price });
                    } else {
                        // 追加処理
                        await addProduct({ name: newProductName, unit: newProductUnit, price: price });
                    }
                    resetForm();
                } catch (error) {
                    console.error("商品操作エラー:", error);
                    showMessageModal(`商品操作中にエラーが発生しました: ${error.message}`);
                }
            };

            // CSVファイル選択ハンドラー
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            importProductsFromCsv(event.target.result);
                        } catch (error) {
                            showMessageModal(`CSVファイルの読み込み中にエラーが発生しました: ${error.message}`);
                            console.error("CSV import error:", error);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            return React.createElement(
                "div",
                { className: "bg-white p-6 sm:p-10 rounded-xl shadow-2xl w-full border border-gray-200" },
                React.createElement(
                    "h1",
                    { className: "text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-8 pb-4 border-b-2 border-blue-200" },
                    "商品管理"
                ),

                /* 商品追加・編集フォーム */
                React.createElement(
                    "form",
                    { onSubmit: handleSubmit, className: "mb-8 p-4 border border-blue-200 rounded-lg bg-blue-50" },
                    React.createElement(
                        "h2",
                        { className: "text-2xl font-semibold text-blue-700 mb-4" },
                        editingProduct ? '商品を修正' : '新しい商品を追加'
                    ),
                    React.createElement(
                        "div",
                        { className: "grid grid-cols-1 md:grid-cols-3 gap-4 mb-4" },
                        React.createElement(
                            "div",
                            { className: "flex flex-col" },
                            React.createElement(
                                "label",
                                { htmlFor: "productName", className: "text-sm font-semibold text-gray-700 mb-1" },
                                "商品名:"
                            ),
                            React.createElement("input", {
                                type: "text",
                                id: "productName",
                                className: "p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",
                                value: newProductName,
                                onChange: (e) => setNewProductName(e.target.value),
                                required: true,
                                placeholder: "例: システム開発費" 
                            })
                        ),
                        React.createElement(
                            "div",
                            { className: "flex flex-col" },
                            React.createElement(
                                "label",
                                { htmlFor: "productUnit", className: "text-sm font-semibold text-gray-700 mb-1" },
                                "単位:"
                            ),
                            React.createElement("input", {
                                type: "text",
                                id: "productUnit",
                                className: "p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",
                                value: newProductUnit,
                                onChange: (e) => setNewProductUnit(e.target.value),
                                required: true,
                                placeholder: "例: 式, 個, 枚" 
                            })
                        ),
                        React.createElement(
                            "div",
                            { className: "flex flex-col" },
                            React.createElement(
                                "label",
                                { htmlFor: "productPrice", className: "text-sm font-semibold text-gray-700 mb-1" },
                                "単価:"
                            ),
                            React.createElement("input", {
                                type: "number",
                                id: "productPrice",
                                className: "p-2 border border-gray-300 rounded-md text-right focus:ring-blue-500 focus:border-blue-500",
                                value: newProductPrice,
                                onChange: (e) => setNewProductPrice(e.target.value),
                                min: "0",
                                required: true,
                                placeholder: "例: 10000" 
                            })
                        )
                    ),
                    React.createElement(
                        "div",
                        { className: "flex justify-end space-x-2" },
                        editingProduct && React.createElement(
                            "button",
                            {
                                type: "button",
                                onClick: resetForm,
                                className: "px-4 py-2 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 transition duration-300"
                            },
                            "キャンセル"
                        ),
                        React.createElement(
                            "button",
                            {
                                type: "submit",
                                className: "px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105"
                            },
                            editingProduct ? '更新' : '追加'
                        )
                    )
                )
,
                /* CSVインポート/エクスポートボタン */
                React.createElement(
                    "div",
                    { className: "mb-8 p-4 border border-green-200 rounded-lg bg-green-50 flex flex-col sm:flex-row justify-center items-center gap-4" },
                    React.createElement(
                        "label",
                        { htmlFor: "csv-import-input", className: "px-6 py-2 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105 cursor-pointer" },
                        "CSVからインポート"
                    ),
                    React.createElement("input", {
                        type: "file",
                        id: "csv-import-input",
                        accept: ".csv,.txt",
                        onChange: handleFileChange,
                        className: "hidden"
                    }),
                    React.createElement(
                        "button",
                        {
                            onClick: exportProductsToCsv,
                            className: "px-6 py-2 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105"
                        },
                        "CSVにエクスポート"
                    )
                )
,
                /* 商品一覧テーブル */
                React.createElement(
                    "h2",
                    { className: "text-2xl font-semibold text-gray-800 mb-4" },
                    "登録商品一覧"
                ),
                productData.length === 0 ? React.createElement(
                    "p",
                    { className: "text-center text-gray-600 italic py-4" },
                    "登録されている商品がありません。"
                ) : React.createElement(
                    "div",
                    { className: "overflow-x-auto shadow-md rounded-lg border border-gray-200" },
                    React.createElement(
                        "table",
                        { className: "min-w-full divide-y divide-gray-200" },
                        React.createElement(
                            "thead",
                            { className: "bg-blue-50" },
                            React.createElement(
                                "tr",
                                null,
                                React.createElement(
                                    "th",
                                    { className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" },
                                    "商品名"
                                ),
                                React.createElement(
                                    "th",
                                    { className: "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" },
                                    "単位"
                                ),
                                React.createElement(
                                    "th",
                                    { className: "px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" },
                                    "単価"
                                ),
                                React.createElement(
                                    "th",
                                    { className: "px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" },
                                    "操作"
                                )
                            )
                        ),
                        React.createElement(
                            "tbody",
                            { className: "bg-white divide-y divide-gray-200" },
                            productData.map(product => React.createElement(
                                "tr",
                                { key: product.id },
                                React.createElement(
                                    "td",
                                    { className: "px-3 py-3 whitespace-nowrap text-sm text-gray-900" },
                                    product.name
                                ),
                                React.createElement(
                                    "td",
                                    { className: "px-3 py-3 whitespace-nowrap text-sm text-gray-900" },
                                    product.unit
                                ),
                                React.createElement(
                                    "td",
                                    { className: "px-3 py-3 whitespace-nowrap text-sm text-gray-900 text-right" },
                                    product.price.toLocaleString('ja-JP')
                                ),
                                React.createElement(
                                    "td",
                                    { className: "px-3 py-3 whitespace-nowrap text-center text-sm" },
                                    React.createElement(
                                        "button",
                                        {
                                            onClick: () => handleEditClick(product),
                                            className: "inline-flex items-center px-3 py-1 bg-yellow-500 text-white text-xs font-bold rounded-md shadow-sm hover:bg-yellow-600 transition duration-200 mr-2"
                                        },
                                        React.createElement(
                                            "svg",
                                            { xmlns: "http://www.w3.org/2000/svg", className: "h-4 w-4 mr-1", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                                            React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: "2", d: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-6l-2-2m2 2l5 5m-5-2l2 2m-2-2l-2-2M15 4l2 2m-2-2l-2 2" })
                                        ),
                                        "編集"
                                    ),
                                    React.createElement(
                                        "button",
                                        {
                                            onClick: () => showConfirmModal('この商品を削除しますか？', () => deleteProduct(product.id)),
                                            className: "inline-flex items-center px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-md shadow-sm hover:bg-red-600 transition duration-200"
                                        },
                                        React.createElement(
                                            "svg",
                                            { xmlns: "http://www.w3.org/2000/svg", className: "h-4 w-4 mr-1", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                                            React.createElement("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: "2", d: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" })
                                        ),
                                        "削除"
                                    )
                                )
                            ))
                        )
                    )
                )
            );
        };


        const App = () => {
            // グローバルなメッセージモーダルステート
            const [globalShowMessageModal, setGlobalShowMessageModal] = useState(false);
            const [globalModalContent, setGlobalModalContent] = useState('');
            const [globalShowConfirmButton, setGlobalShowConfirmButton] = useState(false);
            const [globalConfirmAction, setGlobalConfirmAction] = useState(null);

            // 商品データとページ管理
            const [productData, setProductData] = useState([]);
            const [currentPage, setCurrentPage] = useState('quotation'); // 'quotation' or 'management'
            const [isLoading, setIsLoading] = useState(true); // ローディング状態

            // メッセージモーダル表示関数
            const showMessageModal = (content) => {
                setGlobalModalContent(content);
                setGlobalShowConfirmButton(false);
                setGlobalConfirmAction(null);
                setGlobalShowMessageModal(true);
            };

            // 確認モーダル表示関数
            const showConfirmModal = (content, confirmAction) => {
                setGlobalModalContent(content);
                setGlobalShowConfirmButton(true);
                setGlobalConfirmAction(() => confirmAction); // 関数を直接保存
                setGlobalShowMessageModal(true);
            };

            const closeGlobalModal = () => {
                setGlobalShowMessageModal(false);
                setGlobalModalContent('');
                setGlobalShowConfirmButton(false);
                setGlobalConfirmAction(null);
            };

            const handleGlobalConfirm = () => {
                if (globalConfirmAction) {
                    globalConfirmAction();
                }
                closeGlobalModal();
            };

            // localStorageからのデータ読み込み (初回ロード時のみ)
            useEffect(() => {
                const loadInitialProducts = async () => {
                    try {
                        let initialProducts = [];
                        let loadedFromCSV = false;

                        // 1. Try to load from Data/products.csv
                        try {
                            const response = await fetch('Data/products.csv');
                            if (response.ok) {
                                const csvString = await response.text();
                                const lines = csvString.split('\n').filter(line => line.trim() !== '');
                                const csvProducts = [];
                                let currentMaxId = 0; // Temporary ID counter for CSV products

                                for (const line of lines) {
                                    const parts = line.split(',');
                                    if (parts.length === 3) { // Expecting name, unit, price
                                        const name = parts[0].trim();
                                        const unit = parts[1].trim();
                                        const price = parseFloat(parts[2].trim());
                                        if (name && unit && !isNaN(price)) {
                                            currentMaxId++;
                                            csvProducts.push({ id: currentMaxId, name, unit, price });
                                        } else {
                                            console.warn("Invalid CSV row skipped (missing name, unit, or invalid price):", line);
                                        }
                                    } else {
                                        console.warn("Invalid CSV format skipped (expected 3 parts):", line);
                                    }
                                }
                                // Sort products alphabetically by name
                                initialProducts = csvProducts.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                                loadedFromCSV = true;
                                console.log("Products loaded from Data/products.csv");
                                // 起動時のData/products.csvからの読み込み時はメッセージを表示しない
                                // showMessageModal('商品データを「Data/products.csv」から読み込みました。'); 
                            } else {
                                console.warn(`Failed to fetch Data/products.csv: ${response.status} ${response.statusText}. Falling back to localStorage.`);
                                showMessageModal('「Data/products.csv」の読み込みに失敗しました。ローカルストレージを確認します。');
                            }
                        } catch (csvError) {
                            console.warn("Error fetching Data/products.csv:", csvError);
                            showMessageModal('「Data/products.csv」の読み込み中にエラーが発生しました。ローカルストレージを確認します。');
                        }

                        // 2. If not loaded from CSV, try localStorage
                        if (!loadedFromCSV) {
                            const storedProducts = localStorage.getItem(LOCAL_STORAGE_KEY);
                            if (storedProducts) {
                                const parsedProducts = JSON.parse(storedProducts);
                                // Ensure IDs are unique and sort by name
                                initialProducts = parsedProducts.map((p, index) => ({ ...p, id: p.id || index + 1 }))
                                                                .sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                                console.log("Products loaded from localStorage.");
                                showMessageModal('商品データをローカルストレージから読み込みました。');
                            } else {
                                console.log("No products found in localStorage. Starting with empty data.");
                                showMessageModal('商品データが見つかりませんでした。');
                            }
                        }

                        setProductData(initialProducts);
                        setIsLoading(false); // データロード完了
                    } catch (finalError) {
                        console.error("Failed to initialize products:", finalError);
                        showMessageModal(`商品データの初期化中に致命的なエラーが発生しました: ${finalError.message}`);
                        setIsLoading(false); // エラー時もローディングを解除
                    }
                };

                loadInitialProducts();
            }, []); // Empty dependency array means this runs once on mount

            // productDataが変更されたらlocalStorageに保存
            useEffect(() => {
                if (!isLoading) { // 初期ロードが完了してから保存を開始
                    try {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(productData));
                    } catch (error) {
                        console.error("Failed to save products to localStorage:", error);
                        showMessageModal(`商品データの保存に失敗しました: ${error.message}`);
                    }
                }
            }, [productData, isLoading]);

            // 商品を追加する関数 (localStorageへ)
            const addProduct = async (newProduct) => {
                // IDを生成 (簡易的な連番ID)
                const newId = productData.length > 0 ? Math.max(...productData.map(p => p.id)) + 1 : 1;
                const productWithId = { ...newProduct, id: newId };
                setProductData(prevProducts => {
                    const updated = [...prevProducts, productWithId];
                    // 名前でソートして表示を整理
                    return updated.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                });
                showMessageModal('商品が追加されました。');
            };

            // 商品を更新する関数 (localStorageへ)
            const updateProduct = async (updatedProduct) => {
                setProductData(prevProducts => {
                    const updated = prevProducts.map(p => p.id === updatedProduct.id ? updatedProduct : p);
                     // 名前でソートして表示を整理
                    return updated.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                });
                showMessageModal('商品が更新されました。');
            };

            // 商品を削除する関数 (localStorageへ)
            const deleteProduct = async (id) => {
                setProductData(prevProducts => prevProducts.filter(p => p.id !== id));
                showMessageModal('商品が削除されました。');
            };

            // CSVから商品をインポートする関数
            const importProductsFromCsv = (csvString) => {
                const lines = csvString.split('\n').filter(line => line.trim() !== '');
                const newProducts = [];
                let currentMaxId = productData.length > 0 ? Math.max(...productData.map(p => p.id)) : 0;

                for (const line of lines) {
                    const parts = line.split(',');
                    if (parts.length === 3) { // name, unit, price
                        const name = parts[0].trim();
                        const unit = parts[1].trim();
                        const price = parseFloat(parts[2].trim());

                        if (name && unit && !isNaN(price)) {
                            currentMaxId++;
                            newProducts.push({ id: currentMaxId, name, unit, price });
                        } else {
                            console.warn("Invalid CSV row skipped:", line);
                        }
                    } else {
                        console.warn("Invalid CSV format skipped (expected 3 parts):", line);
                    }
                }

                if (newProducts.length > 0) {
                    setProductData(prevProducts => {
                        // 既存の商品と重複しないようにマージ（名前で重複チェック、簡易的な例）
                        const existingNames = new Set(prevProducts.map(p => p.name));
                        const uniqueNewProducts = newProducts.filter(p => !existingNames.has(p.name));
                        
                        const mergedProducts = [...prevProducts, ...uniqueNewProducts];
                        return mergedProducts.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                    });
                    showMessageModal(`${newProducts.length}件の商品をCSVからインポートしました。`);
                } else {
                    showMessageModal('有効な商品データがCSVファイルに見つかりませんでした。');
                }
            };

            // 商品をCSVにエクスポートする関数
            const exportProductsToCsv = () => {
                if (productData.length === 0) {
                    showMessageModal('エクスポートする商品データがありません。');
                    return;
                }
                const csvContent = productData.map(p => `${p.name},${p.unit},${p.price}`).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'products.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessageModal('商品データをCSVファイルにエクスポートしました！');
            };


            if (isLoading) {
                return React.createElement(
                    "div",
                    { className: "min-h-screen p-4 sm:p-8 bg-gray-100 flex justify-center items-center" },
                    React.createElement(
                        "div",
                        { className: "text-center text-lg font-bold text-gray-700" },
                        "Loading..."
                    )
                );
            }

            return React.createElement(
                "div",
                { className: "min-h-screen p-4 sm:p-8 bg-gray-100 flex justify-center" },
                React.createElement(
                    "div",
                    { className: "w-full max-w-6xl" },
                    /* ナビゲーション */
                    React.createElement(
                        "nav",
                        { className: "mb-6 bg-white p-4 rounded-xl shadow-md flex justify-center space-x-4" },
                        React.createElement(
                            "button",
                            {
                                onClick: () => setCurrentPage('quotation'),
                                className: `px-6 py-2 rounded-lg font-bold transition duration-300 ${
                                    currentPage === 'quotation' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }`
                            },
                            "見積書作成"
                        ),
                        React.createElement(
                            "button",
                            {
                                onClick: () => setCurrentPage('management'),
                                className: `px-6 py-2 rounded-lg font-bold transition duration-300 ${
                                    currentPage === 'management' ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                }`
                            },
                            "商品管理"
                        )
                    )
                    ,

                    /* ページの表示 */
                    currentPage === 'quotation' ? React.createElement(QuotationPage, { productData: productData, showMessageModal: showMessageModal }) : React.createElement(ProductManagementPage, {
                        productData: productData,
                        addProduct: addProduct,
                        updateProduct: updateProduct,
                        deleteProduct: deleteProduct,
                        showMessageModal: showMessageModal,
                        showConfirmModal: showConfirmModal,
                        importProductsFromCsv: importProductsFromCsv, // CSVインポート関数を渡す
                        exportProductsToCsv: exportProductsToCsv    // CSVエクスポート関数を渡す
                    })
                ),
                /* グローバルメッセージモーダルを配置 */
                React.createElement(GlobalMessageModal, {
                    show: globalShowMessageModal,
                    content: globalModalContent,
                    onClose: closeGlobalModal,
                    onConfirm: handleGlobalConfirm,
                    showConfirmButton: globalShowConfirmButton
                })
            );
        };

        // DOMContentLoadedを待ってからReactアプリをレンダリング
        // window.onload を使用して、全てのスクリプトとリソースの読み込みを待つ
        window.onload = function() {
            const container = document.getElementById('root');
            if (window.ReactDOM) { // ReactDOMが定義されているか明示的に確認
                const root = window.ReactDOM.createRoot(container);
                root.render(React.createElement(App));
            } else {
                console.error("ReactDOM is not defined. Cannot render React app.");
                // Fallback UI or error message if ReactDOM is truly unavailable
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">エラー: アプリケーションを読み込めませんでした。ブラウザのコンソールをご確認ください。</div>';
            }
        };
    </script>
</body>
</html>
